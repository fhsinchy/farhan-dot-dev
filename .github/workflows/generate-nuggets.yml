name: Generate Nuggets

on:
  # Trigger when JSON files are added/modified in /ideas/
  push:
    paths:
      - 'ideas/**.json'
      - '!ideas/TEMPLATE.json'  # Ignore template file
    branches:
      - main
      - master
      - feat/content-collections
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      idea_file:
        description: 'Specific idea file to process (e.g., ideas/my-idea.yml)'
        required: false
        type: string

permissions:
  contents: read

jobs:
  generate-nugget:
    runs-on: ubuntu-latest
    environment: master  # Reference the GitHub Environment
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit to detect changes
      
      - name: Detect changed idea files
        id: detect-changes
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.idea_file }}" ]; then
            # Manual trigger with specific file
            echo "files=${{ inputs.idea_file }}" >> $GITHUB_OUTPUT
          else
            # Auto trigger - get changed JSON files (excluding template)
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep '^ideas/.*\.json$' | grep -v 'TEMPLATE.json' || true)
            if [ -z "$CHANGED_FILES" ]; then
              echo "No idea files changed"
              echo "files=" >> $GITHUB_OUTPUT
            else
              echo "Changed files: $CHANGED_FILES"
              echo "files<<EOF" >> $GITHUB_OUTPUT
              echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            fi
          fi
      
      - name: Initialize summary
        if: steps.detect-changes.outputs.files != ''
        run: |
          echo "# ðŸŽ‰ Nugget Generation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: Process idea files
        if: steps.detect-changes.outputs.files != ''
        env:
          WORKER_URL: ${{ vars.WORKER_URL || secrets.WORKER_URL }}
          WORKER_API_KEY: ${{ secrets.WORKER_API_KEY }}
        run: |
          # Validate environment variables
          if [ -z "$WORKER_URL" ] || [ -z "$WORKER_API_KEY" ]; then
            echo "âŒ Error: WORKER_URL or WORKER_API_KEY not set"
            echo "Please configure these in your GitHub Environment 'master'"
            echo "WORKER_URL: ${WORKER_URL:-NOT SET}"
            echo "WORKER_API_KEY: ${WORKER_API_KEY:+SET (hidden)}"
            exit 1
          fi
          
          echo "Using Worker URL: $WORKER_URL"
          
          # Process each changed idea file
          echo "${{ steps.detect-changes.outputs.files }}" | while read -r file; do
            if [ -z "$file" ]; then
              continue
            fi
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ“„ Processing: $file"
            
            # Read JSON file and wrap in {"idea": ...}
            if ! IDEA_JSON=$(jq -c '{idea: .}' "$file" 2>&1); then
              echo "âŒ Failed to parse JSON: $IDEA_JSON"
              continue
            fi
            
            echo "âœ… Parsed JSON successfully"
            
            # Send to Worker API
            echo "ðŸš€ Sending to Worker..."
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$WORKER_URL/ai/generate-nugget" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $WORKER_API_KEY" \
              -d "$IDEA_JSON")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            echo "ðŸ“Š Response code: $HTTP_CODE"
            
            if [ "$HTTP_CODE" -eq 201 ]; then
              echo "âœ… Successfully generated nugget!"
              PR_URL=$(echo "$BODY" | jq -r '.data.pr.prUrl // "N/A"')
              PR_NUMBER=$(echo "$BODY" | jq -r '.data.pr.prNumber // "N/A"')
              SLUG=$(echo "$BODY" | jq -r '.data.nugget.slug // "N/A"')
              
              echo "ðŸ”— PR #$PR_NUMBER: $PR_URL"
              echo "ðŸ“ Slug: $SLUG"
              
              # Add to job summary
              echo "- âœ… **$file** â†’ [PR #$PR_NUMBER]($PR_URL) (slug: \`$SLUG\`)" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ Failed to generate nugget"
              echo "Response: $BODY" | jq '.' || echo "$BODY"
              echo "- âŒ **$file** - Failed (HTTP $HTTP_CODE)" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          done
      
      - name: No changes
        if: steps.detect-changes.outputs.files == ''
        run: |
          echo "No idea files to process"
          echo "# â„¹ï¸ No Changes Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No JSON files in \`/ideas/\` were modified in this commit." >> $GITHUB_STEP_SUMMARY
